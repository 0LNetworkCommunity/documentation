"use strict";(self.webpackChunkopen_libra_core_docs=self.webpackChunkopen_libra_core_docs||[]).push([[6819],{2579:(e,r,o)=>{o.r(r),o.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>n,metadata:()=>s,toc:()=>d});var i=o(5893),t=o(1151);const n={},a="Network Hot Upgrades",s={id:"misc/hot_upgrades",title:"Network Hot Upgrades",description:"Overview",source:"@site/docs/misc/hot_upgrades.md",sourceDirName:"misc",slug:"/misc/hot_upgrades",permalink:"/misc/hot_upgrades",draft:!1,unlisted:!1,editUrl:"https://github.com/0LNetworkCommunity/documentation/edit/main/docs/misc/hot_upgrades.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"genesis_instructions",permalink:"/misc/genesis_instructions"},next:{title:"Key Rotation",permalink:"/misc/key_rotation"}},l={},d=[{value:"Overview",id:"overview",level:2},{value:"Historical Upgrade Information and Proposing Upgrades",id:"historical-upgrade-information-and-proposing-upgrades",level:2},{value:"TLDR",id:"tldr",level:2},{value:"Upgrade Types: Single and Multiple",id:"upgrade-types-single-and-multiple",level:2},{value:"Single Framework Upgrade",id:"single-framework-upgrade",level:3},{value:"Multiple Framework Upgrades",id:"multiple-framework-upgrades",level:3},{value:"Upgrade Policy",id:"upgrade-policy",level:2},{value:"Procedure",id:"procedure",level:2},{value:"Build Artifacts",id:"build-artifacts",level:3},{value:"1. Build the upgrade Move transaction scripts",id:"1-build-the-upgrade-move-transaction-scripts",level:5},{value:"2. Share the output artifacts on Github.",id:"2-share-the-output-artifacts-on-github",level:5},{value:"Upgrade Ceremony",id:"upgrade-ceremony",level:3},{value:"3. With <code>txs</code> anyone (no authority needed) can submit the proposal and metadata. You&#39;ll need to provide the actual script compiled path, and an optional URL which contains documentation of the proposal (e.g github).",id:"3-with-txs-anyone-no-authority-needed-can-submit-the-proposal-and-metadata-youll-need-to-provide-the-actual-script-compiled-path-and-an-optional-url-which-contains-documentation-of-the-proposal-eg-github",level:5},{value:"4. With <code>libra txs</code> anyone with governance authority (the epoch&#39;s validators as of <code>V7</code>), can submit a vote in favor (or against it with <code>--should-fail</code>).",id:"4-with-libra-txs-anyone-with-governance-authority-the-epochs-validators-as-of-v7-can-submit-a-vote-in-favor-or-against-it-with---should-fail",level:5},{value:"6. Use <code>txs</code> to resolve a successfully approved proposal",id:"6-use-txs-to-resolve-a-successfully-approved-proposal",level:5}];function c(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.h1,{id:"network-hot-upgrades",children:"Network Hot Upgrades"}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(r.p,{children:'The "framework" which contains all the consensus, account, econ policies, etc. for the network is written in Move. This code is stored in the network database, and effectively executed on demand. This means that framework upgrades can occur without redeploying the Move VM itself, or the supporting system code (network node software). It also means the state machine can upgrade without a coordinated halt.'}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["To do this we require the ",(0,i.jsx)(r.code,{children:"libra"})," and ",(0,i.jsx)(r.code,{children:"libra-framework"})," cli tools. The command ",(0,i.jsx)(r.code,{children:"libra-framework"})," is used for building the artifacts, and ",(0,i.jsx)(r.code,{children:"libra txs"})," for proposing, voting, and ultimately deploying the artifacts."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"historical-upgrade-information-and-proposing-upgrades",children:"Historical Upgrade Information and Proposing Upgrades"}),"\n",(0,i.jsxs)(r.p,{children:["Historical upgrade information since release 7.0.0 is canonically stored in the ",(0,i.jsx)(r.a,{href:"https://github.com/0LNetworkCommunity/upgrades",children:"upgrade repository"}),". To submit an upgrade proposal, you should draft a PR with the relevant information detailing the upgrade using the provided ",(0,i.jsx)(r.a,{href:"https://github.com/0LNetworkCommunity/upgrades/tree/main/proposals/template",children:"template"})," and include the upgrade script packages."]}),"\n",(0,i.jsx)(r.h2,{id:"tldr",children:"TLDR"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Fetch the latest release"}),": ",(0,i.jsx)(r.code,{children:"cd libra-framework; git fetch --all; git checkout release-x.x.x"})]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Build framework"}),": ",(0,i.jsx)(r.code,{children:"libra-framework  upgrade --output-dir ~/framework_upgrade --framework-local-dir ~/libra-framework/framework/"})]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Propose"}),": ",(0,i.jsx)(r.code,{children:"libra txs governance propose --proposal-script-dir ~/framework_upgrade/1-move-stdlib/ --metadata-url https://github.com/0LNetworkCommunity/upgrades/tree/main/proposals/template"})]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Validators vote"}),": ",(0,i.jsx)(r.code,{children:"libra txs governance  vote --proposal-id <ID>"})]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Resolve"}),":"]}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.code,{children:"libra txs governance resolve --proposal-script-dir ~/framework_upgrade/1-move-stdlib/ --proposal-id 0"})}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.code,{children:"libra txs governance resolve --proposal-script-dir ~/framework_upgrade/2-vendor-stdlib/ --proposal-id 0"})}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.code,{children:"libra txs governance resolve --proposal-script-dir ~/framework_upgrade/3-libra-framework/ --proposal-id 0"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"upgrade-types-single-and-multiple",children:"Upgrade Types: Single and Multiple"}),"\n",(0,i.jsx)(r.p,{children:"When performing upgrades within the network framework, two primary approaches can be employed: single and multiple module upgrades. The key distinction lies in how these upgrades are proposed, voted on, and executed, particularly with respect to handling multiple modules."}),"\n",(0,i.jsx)(r.h3,{id:"single-framework-upgrade",children:"Single Framework Upgrade"}),"\n",(0,i.jsx)(r.p,{children:"A single framework upgrade involves updating a singular set of modules within the framework. This process is straightforward and includes the following steps:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Build Framework"}),": Generate the upgrade Move transaction scripts for the module."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Proposal Submission"}),": Propose the upgrade for the specific framework module."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Validator Voting"}),": Validators within the network vote for or against the proposed upgrade."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Achieving Consensus"}),": The proposal moves forward once it receives support from at least 66% of active validators."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Resolution and Deployment"}),": Resolve the proposal using the exact framework directory that matches the build of the proposed upgrade. This can be done by any validator using the same release branch from the ",(0,i.jsx)(r.code,{children:"libra-framework"})," repository"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"multiple-framework-upgrades",children:"Multiple Framework Upgrades"}),"\n",(0,i.jsx)(r.p,{children:"Multiple framework upgrades require a more nuanced approach, especially regarding resolution stages, to ensure a coherent and secure update across several modules."}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Build Framework"}),": Similar to a single upgrade, start by generating Move transaction scripts for all relevant modules."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Proposal for Initial Module"}),": Propose the upgrade by using the first module (",(0,i.jsx)(r.code,{children:"1-move-stdlib"}),"). This initial proposal is critical as it kickstarts the governance process for the entire upgrade."]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["Importantly, the transaction script for upgrading this first module includes a significant addition: ",(0,i.jsx)(r.strong,{children:"the transaction hash for the subsequent modules"})," that needs upgrading. These hashes, produced during the artifact building phase, serve as secure identifiers for each module's upgrade script."]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Validator Voting"}),": As with single upgrades, validators vote for or against the proposed upgrade."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Achieving Consensus and Sequential Resolution"}),": Once at least 66% of active validators support the proposal, the initial upgrade can be resolved."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Sequential Upgrade Execution"}),": Execute the resolution process for all involved modules, following the order 1-3."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"upgrade-policy",children:"Upgrade Policy"}),"\n",(0,i.jsx)(r.p,{children:"The diem framework has information in the metadata that controls the policy that a publisher can set for upgrading their modules. These are:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Arbitrary(0): Allows code upgrades without compatibility checks, for non-shared packages."}),"\n",(0,i.jsx)(r.li,{children:"Compatible(1): Requires compatibility checks to ensure no breaking changes in public functions or resource layouts."}),"\n",(0,i.jsx)(r.li,{children:"Immutable(2): Prevents any upgrades, ensuring the permanence of critical code."}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["Due to some circumstances, a publisher may want to downgrade the policy to allow changes to go through that a restrictive policy would not allow. We can do this by building the framework with a flag(",(0,i.jsx)(r.code,{children:"--danger-force-upgrade"}),") that sets the upgrade policy as Aribitrary"]}),"\n",(0,i.jsx)(r.p,{children:"Example"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"libra txs governance propose --proposal-script-dir ~/framework_upgrade/3-libra-framework/ --metadata-url https://www.github.com/0LNetworkCommunity/UpdateProposalTemplate --danger-force-upgrade\n"})}),"\n",(0,i.jsx)(r.h2,{id:"procedure",children:"Procedure"}),"\n",(0,i.jsx)(r.p,{children:"We will use this guide to do a multi-step upgrade as this is the most common upgrade that is done."}),"\n",(0,i.jsx)(r.h3,{id:"build-artifacts",children:"Build Artifacts"}),"\n",(0,i.jsx)(r.h5,{id:"1-build-the-upgrade-move-transaction-scripts",children:"1. Build the upgrade Move transaction scripts"}),"\n",(0,i.jsx)(r.p,{children:"This will be a Move package which is machine-generated for a one-time execution. It contains bytecode which will be allowed to be executed (by anyone), once there is a vote and agreement on the proposal passing. The on-chain execution is guarded with a hash of this transaction, which the proposer provides in the proposal transaction (in advance of the vote)."}),"\n",(0,i.jsx)(r.p,{children:"An upgrade script that is tampered with will yield a different execution hash, and will be prevented from running (it is likely to be blocked by the transaction size limits before entering the mempool)."}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"libra-framework upgrade"})," command will produce a newly compiled Move upgrade transaction script, its binary, and the hash."]}),"\n",(0,i.jsx)(r.p,{children:"You need to provide:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"--output-dir"}),": this directory the upgrade transaction files should be saved to. A new folder called ",(0,i.jsx)(r.code,{children:"framework_upgrade"})," will be created under the output-dir path."]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"--framework-local-dir"}),": the source code for the framework so that the transaction script can import it as a dependency."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Optionally you could provide the flag `--danger-force-upgrade"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"# Note the paths\nlibra-framework upgrade --output-dir <OUTPUT_DIR> --framework-local-dir <FRAMEWORK_PATH>\n\n# Example\nlibra-framework upgrade --output-dir ~/framework_upgrade --framework-local-dir ~/libra-framework/framework/\n"})}),"\n",(0,i.jsxs)(r.admonition,{type:"note",children:[(0,i.jsx)(r.p,{children:"This creates 3 seperate library upgrade script directories"}),(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"1-move-stdlib"}),"\n",(0,i.jsx)(r.li,{children:"2-vendor-stdlib"}),"\n",(0,i.jsx)(r.li,{children:"3-libra-framework"}),"\n"]}),(0,i.jsx)(r.p,{children:"You will choose depending on which library you want updated"})]}),"\n",(0,i.jsx)(r.p,{children:"All the artifacts are now created, the proposal transaction can be submitted. But it's a good idea to document this on github first."}),"\n",(0,i.jsx)(r.h5,{id:"2-share-the-output-artifacts-on-github",children:"2. Share the output artifacts on Github."}),"\n",(0,i.jsx)(r.p,{children:"Create a new repository with the outputted directory. Add a README.md file."}),"\n",(0,i.jsx)(r.p,{children:"The proposer can add the link to this Github repo in the proposal phase."}),"\n",(0,i.jsx)(r.h3,{id:"upgrade-ceremony",children:"Upgrade Ceremony"}),"\n",(0,i.jsxs)(r.h5,{id:"3-with-txs-anyone-no-authority-needed-can-submit-the-proposal-and-metadata-youll-need-to-provide-the-actual-script-compiled-path-and-an-optional-url-which-contains-documentation-of-the-proposal-eg-github",children:["3. With ",(0,i.jsx)(r.code,{children:"txs"})," anyone (no authority needed) can submit the proposal and metadata. You'll need to provide the actual script compiled path, and an optional URL which contains documentation of the proposal (e.g github)."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"# note the actual script dir\nlibra txs governance propose --proposal-script-dir <PROPOSAL_SCRIPT_DIR> --metadata-url <URL>\n\n# Example\nlibra txs governance propose --proposal-script-dir ~/framework_upgrade/1-move-stdlib/ --metadata-url https://www.github.com/0LNetworkCommunity/UpdateProposalTemplate\n\n"})}),"\n",(0,i.jsx)(r.p,{children:"If this transaction succeeds it will produce a proposal id, which is a number. Now the proposal is open to voting."}),"\n",(0,i.jsx)(r.admonition,{type:"note",children:(0,i.jsxs)(r.p,{children:["You can query the next proposal using this command: ",(0,i.jsx)(r.code,{children:" libra query view --function-id 0x1::diem_governance::get_next_governance_proposal_id"})]})}),"\n",(0,i.jsxs)(r.h5,{id:"4-with-libra-txs-anyone-with-governance-authority-the-epochs-validators-as-of-v7-can-submit-a-vote-in-favor-or-against-it-with---should-fail",children:["4. With ",(0,i.jsx)(r.code,{children:"libra txs"})," anyone with governance authority (the epoch's validators as of ",(0,i.jsx)(r.code,{children:"V7"}),"), can submit a vote in favor (or against it with ",(0,i.jsx)(r.code,{children:"--should-fail"}),")."]}),"\n",(0,i.jsx)(r.p,{children:'We assume the default is to vote in favor. To vote "approve" simply:'}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"libra txs governance vote --proposal-id <PROPOSAL_ID>\n"})}),"\n",(0,i.jsx)(r.p,{children:"If voter would like the proposal to be rejected:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"libra txs governance vote --proposal-id <PROPOSAL_ID> --should-fail\n"})}),"\n",(0,i.jsx)(r.admonition,{type:"note",children:(0,i.jsxs)(r.p,{children:["You can query to see the for and against votes using this command: ",(0,i.jsx)(r.code,{children:" libra query view --function-id 0x1::diem_governance::get_votes --args <proposal_number>"})]})}),"\n",(0,i.jsxs)(r.p,{children:["After everyone has voted (to reach the consensus threshold of 66% as of ",(0,i.jsx)(r.code,{children:"V7"}),'), the proposal will be in a "Resolvable" state. Anyone can resolve it by submitting the upgrade transaction. This means the sender must have the source transaction script for the upgrade (step #1 above).']}),"\n",(0,i.jsxs)(r.h5,{id:"6-use-txs-to-resolve-a-successfully-approved-proposal",children:["6. Use ",(0,i.jsx)(r.code,{children:"txs"})," to resolve a successfully approved proposal"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"# Note the actual path\nlibra txs governance resolve --proposal-script-dir <PROPOSAL_SCRIPT_DIR> --proposal-id <PROPOSAL_ID>\n\n# Example\n    1. libra txs governance resolve --proposal-script-dir ~/framework_upgrade/1-move-stdlib/ --proposal-id 0\n\n    2. libra txs governance resolve --proposal-script-dir ~/framework_upgrade/2-vendor-stdlib/ --proposal-id 0\n\n    3. libra txs governance resolve --proposal-script-dir ~/framework_upgrade/3-libra-framework/ --proposal-id 0\n"})}),"\n",(0,i.jsx)(r.p,{children:"If this transaction is successful the new bytecode will be written to the VM"})]})}function h(e={}){const{wrapper:r}={...(0,t.a)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},1151:(e,r,o)=>{o.d(r,{Z:()=>s,a:()=>a});var i=o(7294);const t={},n=i.createContext(t);function a(e){const r=i.useContext(n);return i.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function s(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(n.Provider,{value:r},e.children)}}}]);