"use strict";(self.webpackChunkopen_libra_core_docs=self.webpackChunkopen_libra_core_docs||[]).push([[9748],{9490:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"core-devs/smoke-tests","title":"smoke-tests","description":"Smoke Test Harness","source":"@site/docs/core-devs/smoke-tests.md","sourceDirName":"core-devs","slug":"/core-devs/smoke-tests","permalink":"/core-devs/smoke-tests","draft":false,"unlisted":false,"editUrl":"https://github.com/0LNetworkCommunity/documentation/edit/main/docs/core-devs/smoke-tests.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Module and Structure Initialization in Move","permalink":"/core-devs/move-data-initialization"},"next":{"title":"Tools","permalink":"/category/tools"}}');var o=s(4848),r=s(8453);const i={},a=void 0,d={},c=[{value:"Smoke Test Harness",id:"smoke-test-harness",level:2},{value:"How to write tests",id:"how-to-write-tests",level:2},{value:"How to run tests",id:"how-to-run-tests",level:2},{value:"Node Binary",id:"node-binary",level:3},{value:"Stack Overflow",id:"stack-overflow",level:3},{value:"expected error",id:"expected-error",level:3}];function l(e){const t={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h2,{id:"smoke-test-harness",children:"Smoke Test Harness"}),"\n",(0,o.jsx)(t.p,{children:'Smoke tests simulate a network by starting a "swarm" of validators locally on the dev machine. The harness:'}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"simulates a genesis (note this is not the 0L migration genesis, but one tailor made for testing)"}),"\n",(0,o.jsx)(t.li,{children:"exposes some apis that can manage the swarm (start stop individual nodes).\nIt provides introspection into the state of each node."}),"\n",(0,o.jsx)(t.li,{children:"It also provides bindings to the rust SDK such that transactions can be executed in the VM (by the root account or other accounts)."}),"\n",(0,o.jsx)(t.li,{children:"It also provides introspection into the account state (of the root or any account)."}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"how-to-write-tests",children:"How to write tests"}),"\n",(0,o.jsx)(t.p,{children:"The smoke tests should be located in each module (not in the test harness folder), e.g. (tools/txs). This provides wrapper for other modules to import as a dev_dependency. It produces a default swarm with libra configurations and returns the needed types to run tests.\nDon't add functionality tests in this module. The tests here are meta tests to show the harness itself works. Let's keep the dependencies minimal here, to prevent cycling."}),"\n",(0,o.jsx)(t.h2,{id:"how-to-run-tests",children:"How to run tests"}),"\n",(0,o.jsx)(t.h3,{id:"node-binary",children:"Node Binary"}),"\n",(0,o.jsxs)(t.p,{children:["Any tests that depend on ",(0,o.jsx)(t.code,{children:"libra-smoke-tests"})," will require that there is a compiled version of ",(0,o.jsx)(t.code,{children:"diem-node"})," locally."]}),"\n",(0,o.jsxs)(t.p,{children:["For the tests to find the binary's path an environment variable must be set ",(0,o.jsx)(t.code,{children:"DIEM_FORGE_NODE_BIN_PATH"})]}),"\n",(0,o.jsxs)(t.p,{children:["So either export that variable in the test environment (CI), or run inline with ",(0,o.jsx)(t.code,{children:"DIEM_FORGE_NODE_BIN_PATH=path/to/target/release/diem-node"})]}),"\n",(0,o.jsx)(t.h3,{id:"stack-overflow",children:"Stack Overflow"}),"\n",(0,o.jsxs)(t.p,{children:["Since the smoke tests can have nested operations, it's possible that a test function could exceed its stack (e.g. ",(0,o.jsx)(t.code,{children:"txs smoke_publish()"}),"). At test runtime you can change the stack size with a rust env variable ",(0,o.jsx)(t.code,{children:"RUST_MIN_STACK"})]}),"\n",(0,o.jsx)(t.p,{children:"Run with:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"RUST_MIN_STACK=104857600 cargo t smoke_publish\n"})}),"\n",(0,o.jsx)(t.h3,{id:"expected-error",children:"expected error"}),"\n",(0,o.jsx)(t.p,{children:"If you did not export the variable you will see:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"'failed to read env.var. DIEM_FORGE_NODE_BIN_PATH: NotPresent',\n"})})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>i,x:()=>a});var n=s(6540);const o={},r=n.createContext(o);function i(e){const t=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);